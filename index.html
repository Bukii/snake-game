<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Snake-game</title>
    <meta name="author" content="Lukas W.">

    <link rel="stylesheet" type="text/css" href="./style/core.css">
    <link rel="shortcut icon" href="./assets/favicon.ico">
</head>

<body>
    <h1>The one and only snake game!</h1>
    <p>created by <span><a href="https://github.com/Bukii">Lukas W.</a></span></p>
    <p id="points">Length: </p>
    <br>
    <canvas id="canvas" width="400" height="400"></canvas>

    <script>
        var canvas, ctx, points, errorMsg;

        window.onload = function () {
            canvas = document.getElementById("canvas");
            ctx = canvas.getContext("2d");
            points = document.getElementById("points");

            // initial set of the length counter
            points.innerHTML += tailSize;

            document.addEventListener("keydown", keyDownEvent);

            // render X times per second
            var x = 8;
            setInterval(draw, 1000 / x);
        };

        // game world
        var gridSize = (tileSize = 20); // 20 x 20 = 400 and that's the size of the canvas
        var nextX = (nextY = 0);

        // snake
        var defaultTailSize = 2;
        var tailSize = defaultTailSize;
        var snakeTrail = [];
        var snakeX = (snakeY = 10);
        var snakeDir = 0;

        // apple
        var appleX = (appleY = 15);

        // draw
        function draw() {
            // move snake in next pos
            snakeX += nextX;
            snakeY += nextY;

            // snake over game world?
            if (snakeX < 0) {
                snakeX = gridSize - 1;
            }
            if (snakeX > gridSize - 1) {
                snakeX = 0;
            }

            if (snakeY < 0) {
                snakeY = gridSize - 1;
            }
            if (snakeY > gridSize - 1) {
                snakeY = 0;
            }

            //snake bite apple?
            if (snakeX == appleX && snakeY == appleY) {
                // the old tail size is needed to properly display the counter, when the new length of the tailSize
                // has increased by one
                // without this: "Length: 99" --> "Length:100"
                // with this solution: "Length: 99" --> "Length: 100"
                oldTailSize = tailSize.toString().length;

                tailSize++;

                // imcrement length counter
                points.innerHTML = points.innerHTML.substring(0, points.innerHTML.length - oldTailSize) +
                    tailSize;

                appleX = Math.floor(Math.random() * gridSize);
                appleY = Math.floor(Math.random() * gridSize);

                var done = true;
                while (true) {
                    // reset done after every try to get proper results
                    done = true;

                    for (var i = 0; i < snakeTrail.length; i++) {
                        if (snakeTrail[i].x == appleX && snakeTrail[i].y == appleY) {
                            // if x and y coordinate of any part of the snakeTrail is equal to the apples position
                            // get new appleX and appleY
                            appleX = Math.floor(Math.random() * gridSize);
                            appleY = Math.floor(Math.random() * gridSize);

                            // set done to false, so it will loop another time to check if the new apples coordinates
                            // don't match the coordinates of any part of the snake
                            done = false;

                            // could also use break but since that worked for me, I just kept it
                            i = snakeTrail.length;
                        }
                    }

                    // if done is true (if the coordinates don't interfere with each other) 
                    //it breaks out of the while and continues with the normal code
                    if (done) {
                        break;
                    }
                }
            }

            //paint background
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // paint snake
            ctx.fillStyle = "green";
            for (var i = 0; i < snakeTrail.length; i++) {
                ctx.fillRect(
                    snakeTrail[i].x * tileSize,
                    snakeTrail[i].y * tileSize,
                    tileSize,
                    tileSize
                );

                //snake bites it's tail?
                if (snakeTrail[i].x == snakeX && snakeTrail[i].y == snakeY) {
                    tailSize = defaultTailSize;

                    // set length count to zero
                    points.innerHTML = "Length: " + tailSize;
                }
            }

            // paint apple
            ctx.fillStyle = "red";
            ctx.fillRect(appleX * tileSize, appleY * tileSize, tileSize, tileSize);

            //set snake trail
            snakeTrail.push({
                x: snakeX,
                y: snakeY
            });
            while (snakeTrail.length > tailSize) {
                snakeTrail.shift();
            }
        }

        // input
        // starting with left and then going clockwise
        function keyDownEvent(e) {
            switch (e.keyCode) {
                case 37: // left
                    if (snakeDir != 39) {
                        nextX = -1;
                        nextY = 0;
                        snakeDir = 37;
                    } else {
                        unableKeyEvent();
                    }
                    break;
                case 38: // up
                    if (snakeDir != 40) {
                        nextX = 0;
                        nextY = -1;
                        snakeDir = 38;
                    } else {
                        unableKeyEvent();
                    }
                    break;
                case 39: // right
                    if (snakeDir != 37) {
                        nextX = 1;
                        nextY = 0;
                        snakeDir = 39;
                    } else {
                        unableKeyEvent();
                    }
                    break;
                case 40: // down
                    if (snakeDir != 38) {
                        nextX = 0;
                        nextY = 1;
                        snakeDir = 40;
                    } else {
                        unableKeyEvent();
                    }
                    break;
            }
        }

        // function to display an error
        function unableKeyEvent(e) {
            // delete the old element in the tree, so it won't overflow
            if (document.getElementById("errorMsg") != null) {
                oldOne = document.getElementById("errorMsg");
                oldOne.parentNode.removeChild(oldOne);
            }
            // create a new paragraph element to display the error message
            var myErrorMsg = document.createElement('p');
            myErrorMsg.id = "errorMsg";

            // get all position-related attributes of the canvas
            var rect = canvas.getBoundingClientRect();

            // style the error message
            // it is essential to make it's position absolute, so the upper part won't move and adjust,
            // when the error message gets displayed
            myErrorMsg.style.position = "absolute";
            myErrorMsg.style.display = "float";
            myErrorMsg.style.width = rect.width + "px";
            myErrorMsg.style.top = rect.bottom + "px";
            myErrorMsg.style.color = "red";
            myErrorMsg.innerHTML = "Unable to move into myself!";

            // output the error message after the canvas
            canvas.after(myErrorMsg);
        }
    </script>
</body>

</html>